yes# AI MASTER PROTOCOL: THE CODE CONSTITUTION (GEMINI.md)

> **STATUS:** SUPREME LAW  
> **APPLICABILITY:** GLOBAL (all products/projects in this workspace)  
> **ENFORCEMENT:** MANDATORY for all AI agents and human contributors

This document defines the non-negotiable standards for building production systems at scale.
Violations are treated as release blockers unless an approved time-bound risk waiver exists.

---

## ðŸ›ï¸ VOLUME I: THE SUPREME CORE (MANDATORY)
The Supreme Core is the foundation of all work. These rules are **ALWAYS ACTIVE** and must be followed regardless of the project scale or technology stack. 

Specific domain protocols (Backend, Database, etc.) are available in **VOLUME II** and should be implemented based on the task requirement.

---

## 0. APPLICABILITY & SCOPE
- **Core Rules:** mandatory for all projects.
- **Stack Modules:** apply only when that stack is used.
- **Non-Blocking:** missing stack/tech never disables core engineering controls.

---

## 1. GOVERNANCE PROTOCOL

### 1.1 PRD Mandate (Absolute)
- Every new or existing project must maintain a living PRD.
- No planning or implementation without PRD alignment.

### 1.2 Execution Lock (Before Coding)
Before writing code, contributors must provide:
1. current vs desired state
2. impact analysis (contracts, dependencies, data risk)
3. step-by-step technical plan
4. explicit proceed checkpoint

### 1.3 Communication Discipline
- No fluff; use direct, concrete language.
- Read nearest context docs (`PROJECT_CONTEXT.md`, PRD, runbooks) before assumptions.

### 1.4 Change Control
- High-impact changes (auth, payments, data model, tenancy, infra) require ADR entry.
- Every release must include rollback path and blast radius note.

### 1.5 Threat Modeling Gate (Mandatory)
- Major features (auth, payments, PII, admin actions, public inputs) require abuse-case threat model before implementation.
- Threat model must include trust boundaries, misuse paths, mitigations, and residual risk owner.
- Merge blocked for critical modules without linked threat model artifact.

### 1.6 Definition of Done (DoD)
- No â€œdoneâ€ claim unless required checks pass (`check-types`, `lint`, `build`, required tests).
- Release candidates must be verified via CLI (`gh run`, `vercel logs`) to ensure environment-agnostic stability.
- No dependency on "Success" markers in UI/browser; terminal-based verification is the source of truth.

### 1.7 ORR Gate (Operational Readiness Review)
- Production launch requires ORR sign-off from engineering, security, and operations.
- ORR must pass security checks, performance/SLO checks, rollback validation, runbook readiness, and cost guardrails.

---

## 12. STANDALONE PROJECT ECOSYSTEM RULES
- **Mandatory Encapsulation**: Every project must be self-contained. No cross-project file leakage.
- **Hierarchy**: `src/` (code), `docs/` (non-code), `db/` (migrations), `scripts/` (tooling), `internal/` (templates).
- **Pristine Root**: Only config files and constitutions (`AGENTS.md`, `GEMINI.md`) at root.

---

### 13.1 Deployment Tiers
Projects MUST define their "Readiness Tier" in the local PRD or `GEMINI.md`.

- **Tier-0 (Giant Stage)**: 100% enforcement. Includes extreme operational audits, Chaos Engineering, formal ORR gates, and full DR simulations. Reserved for flagship monetization/critical infrastructure.
- **Tier-1 (Production)**: 80% enforcement. Mandatory Core Excellence. May skip Chaos Drills and Multi-Region HA if justified.
- **Tier-2 (Prototype/MVP)**: 50% enforcement. 
    - **MANDATORY**: Core Excellence (Speed, Performance, Security, Scalability, Testing, Debugging). 
    - **SKIPPABLE**: Tech-Giant "Process Overhead" (Formal Audits before every change, Chaos Drills, formal ORR gates). This ensures rapid development without compromising code quality.

### 13.2 Strategic Planning & Enforcement
- **Requirement-Driven Design**: Before implementation, analyze project scale to create a proportionate System Design plan. Do not apply Tier-0 overhead to Tier-2 projects. Over-engineering is a violation of efficiency.
- **Enforcement**: Any waiver of a Section 1-12 rule must be explicitly documented as a "Time-Bound Risk Waiver" with an owner and expiration.

---

## 15. CONTEXT MEMORY PROTOCOL

### 15.1 Mandatory Documentation (The "Memory" Mandate)
- Every project must maintain a `/context` directory at the root.
- **Minimum Required Artifacts**:
  - `architecture.md`: High-level system design and data flow.
  - `decisions.md`: Log of critical architectural choices and "Why".
  - `current-state.md`: Active task focus and immediate objectives.
  - `known-issues.md`: Operational gotchas and technical debt.

### 15.2 Anti-Hallucination Guardrail
- AI agents MUST read the `/context` directory before starting any major task.
- Agents are responsible for updating `current-state.md` after significant progress.

---

## 16. ENFORCEMENT
- Constitution violations are release blockers unless approved with explicit risk acceptance.
- Waiver must include owner, reason, mitigation, and expiration date.

---

> [!IMPORTANT]
> **The Supreme Core above must ALWAYS be followed. Specialized protocols in Volume II are to be chosen and implemented based on the specific task requirements.**

---

## ðŸŒ² VOLUME II: SPECIALIZED BRANCH PROTOCOLS (ON-DEMAND)
Based on the task area (Backend, Database, Frontend, etc.), the agent must implement the corresponding protocol below while remaining strictly compliant with the **Supreme Core**.

---

### 1. BACKEND & API DESIGN PROTOCOL
Includes: Architecture, API Design, and Background Work.

#### 2. ARCHITECTURE PROTOCOL

### 2.1 Clean Layering
- **Controllers/Route Handlers:** routing, validation, auth guard, response only.
- **Services:** business logic only.
- **Repositories/Data Layer:** persistence/query concerns only.
- Vendor SDK calls in controllers are forbidden.

### 2.2 Domain Boundaries
- Explicit modules and ownership boundaries are required.
- Cross-domain integration must use typed contracts, not ad-hoc internal coupling.

### 2.3 Global Handling
- Global exception handlers only; raw stack traces must not reach users.
- Standard API envelope or documented equivalent contract is mandatory.

### 2.4 Third-Party Interaction
- External providers must be wrapped in service adapters with timeout, retry, circuit-breaker behavior, and typed errors.

### 2.5 Long-Running Work
- Operations expected >2s go to queue/background execution with retries and DLQ.

#### 3. API DESIGN, VERSIONING & LIFECYCLE

### 3.1 Response Contract
- Standard envelope required for external APIs:
  - `{ success: boolean, data?: T, error?: { code: string, message: string } }`

### 3.2 API Versioning
- Public APIs must be versioned (`/api/v1` minimum).
- Breaking changes require new version (`/api/v2`, `/api/v3`) â€” no silent contract mutation.

### 3.3 Compatibility Policy
- Breaking contract changes require deprecation window + migration guide.
- Old stable version remains supported until sunset date.

### 3.4 API Deprecation SLA
- Minimum 90-day notice for external deprecations (except emergency security override).
- Deprecation requires migration docs, traffic telemetry, and fixed sunset date.

### 3.5 Idempotency & Reliability
- Critical mutations (payments, credits, unlocks, settlements, refunds) must require idempotency keys.
- Server stores `(actor_id, route, key)` + request hash + final response for replay safety.
- Per-route timeout budgets, safe retry policy, and correlation IDs are mandatory.

### 3.6 API Security
- Strict schema validation and unknown-field stripping.
- Ownership + role checks on all write endpoints.
- Rate limits by endpoint sensitivity.

---

### 2. DATABASE PERFORMANCE & INTEGRITY PROTOCOL
Includes: Schema, Migrations, Query Performance, and Concurrency.

#### 4. DATABASE PERFORMANCE & INTEGRITY

### 4.1 Schema & Migration Discipline
- Never edit historical migrations; append new migrations only.
- Destructive changes require explicit backup + rollback strategy.
- Live systems must follow zero-downtime migration pattern: **Expand â†’ Migrate â†’ Contract**.

### 4.2 Scalability & Indexing
- Index all foreign keys and hot filter/sort columns.
- Use partial indexes for hot subsets and GIN/GIST for JSONB/search use-cases.
- Prefer sortable IDs (UUIDv7/Snowflake-style) for high-write tables.
- No forced retroactive PK migration without phased rollout plan.

### 4.3 Query Discipline
- N+1 queries are banned.
- Use joins/includes/batching/pre-aggregation.
- Heavy analytics should use materialized views or equivalent with refresh strategy.

### 4.4 Connection & Timeout Policy
- Production DB access must use connection pooler (PgBouncer/managed equivalent).
- Tiered timeouts:
  - request-path OLTP: 5â€“10s
  - background/reporting: 30â€“60s
  - app-facing lock safety: `lock_timeout` 1â€“2s

### 4.5 Transactional Integrity
- Multi-table writes must be atomic.
- Financial/inventory/credits/bidding flows require strict transactional locking strategy.

### 4.6 Data Lifecycle & Recovery
- Data retention/archival/deletion policy by classification is mandatory.
- Backups, restore drills, and declared `RPO`/`RTO` targets are mandatory.

### 4.7 Multi-Tenant Safety
- Tenant-scoped queries and tenant isolation controls are mandatory.
- RLS/tenant guards required for multi-tenant systems.
- No cross-tenant leakage in logs/exports/analytics/cache.

---

### 3. SECURITY & DATA PRIVACY PROTOCOL
Includes: Auth, Secrets, Compliance, and Data Protection.

#### 5. SECURITY, PRIVACY & COMPLIANCE

### 5.1 Authentication & Session
- Secure HttpOnly cookies for web sessions in production.
- Sensitive auth tokens in localStorage are forbidden.
- Admin and privileged operations require stronger auth controls (MFA/step-up).

### 5.2 Authorization
- Enforce RBAC at route + service + DB policy layers.
- Sensitive actions require explicit permission checks and audit logging.

### 5.3 Secrets & Key Management
- No secrets in code or committed env files.
- Production secrets must use managed secret store.
- Cryptographic keys must be managed in KMS/HSM/Vault with owner + rotation SLA.
- Rotation SLA: high-risk keys <= 90 days, standard keys <= 180 days.
- Emergency revoke/reissue runbook is mandatory and tested quarterly.

### 5.4 Input/Output Safety
- Parameterized queries only (SQL injection prevention).
- XSS-safe rendering with strict CSP policy.
- CSRF protection for cookie-based auth write routes.

### 5.5 Headers & CORS
- Mandatory production headers: `CSP`, `HSTS`, `X-Content-Type-Options: nosniff`, `Referrer-Policy`, `Permissions-Policy`.
- Strict CORS allowlist only; wildcard origins forbidden in production.
- `X-XSS-Protection` must not be used as primary control.

### 5.6 Supply-Chain Security
- Dependency scanning and lockfile integrity checks are mandatory.
- Critical CVEs are release blockers.
- SBOM generation required for production-grade releases.
- Signed artifacts + provenance attestations required for release pipelines.
- OSS license allowlist/denylist policy required.

### 5.7 Data Privacy
- Never log plaintext PII/secrets/tokens.
- Sensitive fields must be masked in logs/diagnostics.
- Purpose-limited collection and compliant export/delete flows are mandatory.

### 5.8 Data Classification Matrix
- Data must be classified (P0/P1/P2) with per-tier encryption, masking, retention, and access rules.
- P0 data (auth secrets, financial identity, high-risk PII) requires strongest controls.

### 5.9 Privileged Access Governance
- Break-glass access must be isolated, MFA-protected, short-lived, and fully audited.
- JIT privileged access with approval trail is mandatory.
- Access review cadence is mandatory (minimum quarterly).

---

### 4. PERFORMANCE & QUALITY PROTOCOL
Includes: Performance Budgets, Caching, and Quality Engineering.

#### 7. PERFORMANCE & SCALABILITY STANDARDS

### 7.1 Backend Performance Budgets
- Define p50/p95/p99 targets by API class (public, internal, admin, webhook).
- Query-count budget and hot-endpoint profiling must be enforced.

### 7.2 Frontend Performance Budgets
- Core Web Vitals thresholds (P75 production):
  - LCP < 2.5s
  - CLS < 0.1
  - INP < 200ms
- Route-class JS bundle budgets enforced in CI.

### 7.3 Rendering & Data Efficiency
- Use dynamic imports for heavy client modules.
- Virtualize large lists/tables (>50 rows) or enforce strict server pagination.
- Debounce search/filter and throttle high-frequency handlers.

### 7.4 Caching Strategy
- Multi-layer caching policy (edge/app/data layer) with explicit invalidation and stale-data policy.

### 7.5 Capacity Planning
- Load and stress test gates required before major release.
- Autoscaling thresholds and capacity headroom policy required.

### 7.6 Scalability Architecture
- Read/write separation and partition strategy for growth hotspots.
- Async/event-driven design for burst-heavy workflows.
- Multi-region strategy and failover objective documentation required.

#### 10. QUALITY ENGINEERING

### 10.1 Test Strategy
- Unit + integration + E2E coverage required for critical journeys.
- Every bug fix must include regression test update.

### 10.2 Contract & Migration Testing
- API contract tests are mandatory for external/client-facing interfaces.
- Migration compatibility checks required for zero-downtime goals.

### 10.3 Non-Functional Testing
- Release candidates require security, load, and resilience validation.

---

### 5. OPERATIONS & RELIABILITY PROTOCOL
Includes: SRE, DevOps, Documentation, and Costs.

#### 6. RELIABILITY, SRE & OPERATIONS

### 6.1 SLI/SLO & Error Budgets
- Define SLI/SLO for availability, latency, and error rate for critical journeys.
- Default baselines (unless stricter product targets exist):
  - Tier-0 availability >= 99.95%
  - Tier-1 availability >= 99.90%
  - Request-path API p95 <= 300ms, p99 <= 800ms
  - Monthly error rate <= 1%
- Error-budget freeze policy:
  - >50% burn mid-window: freeze risky feature releases
  - >=100% burn: release freeze until remediation approval

### 6.2 Observability
- Structured JSON logs with `traceId`, actor/user id, and resource identifiers.
- Metrics + traces + logs correlation is mandatory.
- Critical business events must emit auditable telemetry.

### 6.3 Incident Management
- Sev matrix (SEV-1..SEV-4), on-call rotation, escalation tree required.
- Sev-1/Sev-2 incidents require postmortem with owners and due dates.

### 6.4 Resilience Patterns
- Timeout + retry + circuit-breaker + bulkhead isolation required for external dependencies.
- Graceful degradation for non-critical paths.
- Async retry with DLQ required for durable job workflows.

### 6.5 Health, Backup & DR
- Liveness/readiness/startup checks required for deployable services.
- Runbooks for failover/rollback/partial outage are mandatory.
- Backup-restore drill: monthly.
- Full DR/failover simulation: quarterly.
- Drill evidence must include measured `RPO`/`RTO` and remediation actions.

### 6.6 Chaos Engineering / GameDay
- Controlled fault-injection exercises required:
  - monthly in non-prod
  - quarterly in production-safe scope
- Pass criteria must include alert quality, bounded blast radius, and recovery within objective.

#### 8. RELEASE ENGINEERING & DEVOPS

### 8.1 CI/CD Gates
- Required gates: type checks, lint, unit/integration tests, security scan, build.
- Block merge on failed required gates.
- CI must hard-fail release candidates on SLO/performance/cost budget breaches.
- CI must validate SBOM generation + signature/provenance checks.

### 8.2 Progressive Delivery
- Prefer canary/blue-green over blind full rollout.
- Automatic rollback triggers on SLO regressions.

### 8.3 Environment Policy
- Strict dev/stage/prod separation.
- Production debug bypass flags forbidden.
- Config parity and migration compatibility must be validated pre-release.

### 8.4 Feature Flags
- Risky changes must be flaggable.
- Every flag needs owner, expiry date, and cleanup policy.

### 8.5 Infrastructure as Code
- Infrastructure must be reproducible via IaC.
- Manual production config drift is prohibited.

### 8.6 Release Freeze Triggers
- Release freeze is mandatory on: exhausted error budget, unresolved Sev-1/Sev-2, failed ORR, failed DR/chaos critical checks, or unresolved critical security vulnerability.

### 8.7 Operational Tooling (Terminal-First)
- **Tooling Mandate**: GitHub CLI (`gh`) and Vercel CLI (or stack equivalent) must be installed and authenticated.
- **Platform Observability**: Agents must use `gh run view` and `vercel logs` to debug CI/CD failures. No manual browser debugging for build logs.
- **Automation**: PR creation, merging, and secret rotation should be performed via CLI to ensure auditable, repeatable workflows.

#### 9. FINOPS & COST GOVERNANCE

### 9.1 Cost Controls
- Monthly budgets per environment and service are mandatory.
- Cost alert thresholds with owner and remediation runbook required.

### 9.2 Cost Observability
- Track cost by critical journey and major service.
- Tenant/cohort-level cost visibility should be enabled where applicable.

### 9.3 Efficiency Policy
- Auto-cleanup policy required for stale resources, orphan snapshots, and unused workloads.

#### 11. DOCUMENTATION & RUNBOOK STANDARD

### 11.1 Required Artifacts
- PRD, architecture diagram, ADRs, API contract docs, runbooks, incident playbook.

### 11.2 Ownership Model
- Every module must have named owner.
- Every alert/runbook must map to accountable owner/team.

---

**Signed & Enforced by:** Harun Shaikh  
**Effective Date:** Immediate
